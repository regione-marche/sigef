CREATE PROCEDURE [dbo].[calcoloStep111_8]
@IdProgetto int
AS
BEGIN

-- 111 a  MACROFILIERE  - rispetto massimale di aiuto 111 a per impresa (1500 € / anno + 6000 € / periodo 2007-13)
-- COME RIFERIMENTO PER  ANNO SOLARE : DATA DI PRESENTAZIONE DEL PROGETTO

DECLARE @Result int, @COUNT INT , @ID_BANDO INT,@ID_IMPRESA INT,@ID_PROGETTO INT,
		@ANNO INT,@COSTO_IMPRESA_ANNO DECIMAL(18,2) ,
		@FASE_ISTRUTTORIA BIT,@COSTO_IMPRESA_PERIODO  DECIMAL(18,2)

SET @Result = 1 -- Impongo lo Step verificato

-- ELENCO PROGETTI FINANZIATI NELLA MISURA  111 
-- CONTROLLO I PROGETTO AMMISSIBILI 

SELECT @ANNO = YEAR( DATA), @ID_IMPRESA = P.ID_IMPRESA 
FROM PROGETTO P INNER JOIN PROGETTO_STORICO PS ON PS.ID_PROGETTO = P.ID_PROGETTO WHERE P.ID_PROGETTO=@IdProgetto AND COD_STATO = 'L'

DECLARE PROGETTO CURSOR FOR
	SELECT PB.ID_BANDO, P.ID_PROGETTO 
	FROM vBANDO_PROGRAMMAZIONE AS PB 
		 INNER JOIN vPROGETTO AS P ON PB.ID_BANDO = P.ID_BANDO AND ((P.ORDINE_FASE >= 3 AND P.COD_STATO NOT IN ('N', 'R', 'B'))OR(P.ORDINE_FASE >=2 AND P.ID_PROGETTO = @IdProgetto))
		 INNER JOIN PROGETTO_STORICO PS_DEF ON PS_DEF.ID_PROGETTO = P.ID_PROGETTO AND PS_DEF.COD_STATO = 'L' AND YEAR(PS_DEF.DATA) = @ANNO
	WHERE (PB.MISURA_PREVALENTE = 1) AND pb.CODICE like '1.1.1%' AND PB.COD_PSR LIKE 'PSR%' AND (PB.ID_DISPOSIZIONI_ATTUATIVE IS NULL) AND ID_IMPRESA= @ID_IMPRESA 
	ORDER BY PB.ID_BANDO, ID_PROGETTO 

SET @COSTO_IMPRESA_ANNO =0					  

OPEN PROGETTO
FETCH NEXT FROM PROGETTO 
INTO  @ID_BANDO  , @ID_PROGETTO 
WHILE @@FETCH_STATUS = 0
BEGIN
  SET @COSTO_IMPRESA_ANNO = @COSTO_IMPRESA_ANNO + ( SELECT dbo.calcoloCostoTotaleProgetto(  @ID_PROGETTO, 1 , (SELECT MAX(ID_VARIANTE) FROM VARIANTI  WHERE ID_PROGETTO = @IdProgetto)))
    
 FETCH NEXT FROM PROGETTO
 INTO @ID_BANDO, @ID_PROGETTO 
END

CLOSE PROGETTO
DEALLOCATE PROGETTO 

-- MASSIMALE PER IMPRESA PER ANNO SOLARE 
IF (@COSTO_IMPRESA_ANNO >1500 ) BEGIN SET @Result=0 END 
ELSE BEGIN 
   DECLARE PROGETTO_PERIODO CURSOR FOR
   SELECT PB.ID_BANDO, ID_PROGETTO 
   FROM vBANDO_PROGRAMMAZIONE AS PB 
		INNER JOIN vPROGETTO AS P ON PB.ID_BANDO = P.ID_BANDO AND( (P.ORDINE_FASE >= 3  AND P.COD_STATO NOT IN ('N', 'R', 'B') ) OR ( P.ORDINE_FASE >= 2  AND P.ID_PROGETTO = @IdProgetto))
   WHERE (PB.MISURA_PREVALENTE = 1) AND pb.CODICE like '1.1.1%' AND PB.COD_PSR LIKE 'PSR%' AND 
		 (PB.ID_DISPOSIZIONI_ATTUATIVE IS NULL) AND ID_IMPRESA = @ID_IMPRESA
   GROUP BY PB.ID_BANDO, ID_PROGETTO 
 
  SET @COSTO_IMPRESA_PERIODO =0 
  OPEN PROGETTO_PERIODO 
  FETCH NEXT FROM PROGETTO_PERIODO 
  INTO @ID_BANDO , @ID_PROGETTO 
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @FASE_ISTRUTTORIA = ( SELECT FLAG_DEFINITIVO FROM PROGETTO WHERE ID_PROGETTO = @ID_PROGETTO)			
		SET @COSTO_IMPRESA_PERIODO = @COSTO_IMPRESA_PERIODO +  (SELECT dbo.calcoloCostoTotaleProgetto( @ID_PROGETTO, @FASE_ISTRUTTORIA , (SELECT MAX(ID_VARIANTE) FROM VARIANTI  WHERE ID_PROGETTO = @IdProgetto)))
     
	FETCH NEXT FROM PROGETTO_PERIODO
	INTO @ID_BANDO, @ID_PROGETTO 
	END
	CLOSE PROGETTO_PERIODO
	DEALLOCATE PROGETTO_PERIODO
 END
 
IF( @COSTO_IMPRESA_PERIODO > 6000 ) SET @Result =0
SELECT @Result AS RESULT
END
