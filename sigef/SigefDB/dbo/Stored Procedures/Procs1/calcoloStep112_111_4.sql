CREATE  PROCEDURE [dbo].[calcoloStep112_111_4]
@IdProgetto int

-- 111 - Verifica massimali da intervento su corsi di formazione  
--FATTO!!! 
 
AS
-- TROVO IL PROGETTO INTEGRATO
DECLARE @ID_PROG_INTEG_111 INT,@Result INT ,
		@COUNT_CODIFICA int, @COUNT_SPEC INT, 
		@ID_DETTAGLIO_INVESTIMENTO INT, @COSTO DECIMAL(18,2)

SET @Result = 1

SELECT DISTINCT @ID_PROG_INTEG_111 = p.ID_PROGETTO FROM PROGETTO P
INNER JOIN BANDO B ON B.ID_BANDO = P.ID_BANDO INNER JOIN ZPROGRAMMAZIONE ZP ON ZP.ID =B.ID_PROGRAMMAZIONE AND CODICE = '1.1.1.A'
WHERE ID_PROG_INTEGRATO = @IdProgetto
--controllo la completa indicazione della specifica
SET  @COUNT_SPEC = (SELECT COUNT(*) FROM PIANO_INVESTIMENTI I  
					WHERE ID_PROGETTO = @ID_PROG_INTEG_111 AND ID_INVESTIMENTO_ORIGINALE IS NULL 
							AND ID_VARIANTE IS NULL AND ID_SPECIFICA_INVESTIMENTO IS NULL )
IF( @COUNT_SPEC =0 )
BEGIN 
  DECLARE CORSO_SEDE CURSOR FOR
  ( 
		SELECT SUM(COSTO_INVESTIMENTO) AS COSTO , ID_DETTAGLIO_INVESTIMENTO
		FROM PIANO_INVESTIMENTI PI WHERE ID_PROGETTO =@IdProgetto AND ID_INVESTIMENTO_ORIGINALE IS NULL
		GROUP BY ID_DETTAGLIO_INVESTIMENTO
   ) 
 
OPEN CORSO_SEDE
FETCH NEXT FROM CORSO_SEDE 
INTO @COSTO,@ID_DETTAGLIO_INVESTIMENTO 
WHILE @@FETCH_STATUS = 0
	BEGIN
	IF (@ID_DETTAGLIO_INVESTIMENTO IN (2999,7544 )) BEGIN IF(@COSTO<934.63 OR @COSTO >1752.63) SET @Result =0 END-- MIN 934.63;  MAX 1.752,63
		ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3000,3002,3003,3004,3006,3007,3008,3011,
													  7545,7547,7548,7549,7551,7552,7553,7556))BEGIN IF(@COSTO<1000.00 OR @COSTO >1875.00) SET @Result =0 END
			ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3001,7546))BEGIN IF(@COSTO<993.33 OR @COSTO >1862.50) SET @Result =0 END
				ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3005,7550))BEGIN IF(@COSTO<800 OR @COSTO >1500) SET @Result =0 END
					ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3009,7554))BEGIN IF(@COSTO<904.25  OR @COSTO >1695.46) SET @Result =0 END --904.25 1.695,46
						ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3010,7555))BEGIN IF(@COSTO<854.25  OR @COSTO >1601.71) SET @Result =0 END--854.25 1.601,71
							ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3012,3013,3014,3015,3016,3017,3018,3020,3021,3022,3023,3025,3026,3027,3028,3029,3030, 
																			7558,7559,7560,7561,7562,7563,7564,7566,7567,7568,7569,7571,7572,7573,7574,7575,7576))BEGIN IF(@COSTO<400  OR @COSTO >750) SET @Result =0 END--400,00 750,00
								ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3019,7565))BEGIN IF(@COSTO<324  OR @COSTO >607.50) SET @Result =0 END--324,00 607,50
									ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3024,7570))BEGIN IF(@COSTO<387.50  OR @COSTO >726.56) SET @Result =0 END --387,50 726,56
										ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3031,7577))BEGIN IF(@COSTO<160  OR @COSTO >300) SET @Result =0 END --160,00 300,00
											ELSE BEGIN IF (@ID_DETTAGLIO_INVESTIMENTO IN (3032,3033,7578,7579))BEGIN IF(@COSTO<389.47  OR @COSTO >730.25) SET @Result =0 END --389.47 730.25
											END	
										END	
									END		
								END		
							END		
						END		
					END				
				END											
			END	
		END 			
FETCH NEXT FROM CORSO_SEDE
INTO @COSTO , @ID_DETTAGLIO_INVESTIMENTO 
END

CLOSE CORSO_SEDE
DEALLOCATE CORSO_SEDE

END
ELSE   SET @Result= 0
 
SELECT @Result AS RESULT
