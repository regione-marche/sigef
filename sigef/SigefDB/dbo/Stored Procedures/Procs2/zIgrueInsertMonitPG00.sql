CREATE PROCEDURE [dbo].[zIgrueInsertMonitPG00]
( 
 @DataDa DATETIME,
 @DataA DATETIME,
 @IdInvio INT,
 @rNumber INT
)
AS
BEGIN
INSERT INTO IGRUE_MONIT.dbo.IGRUE_PG00
(
COD_LOCALE_PROGETTO,
COD_PROC_AGG,
CIG,
MOTIVO_ASSENZA_CIG,
DESCR_PROCEDURA_AGG,
TIPO_PROC_AGG,
IMPORTO_PROCEDURA_AGG,
DATA_PUBBLICAZIONE,
IMPORTO_AGGIUDICATO,
DATA_AGGIUDICAZIONE,
FLG_CANCELLAZIONE,
--OPERAZIONE,
ID_INVIO,
NR_RIGA_INVIO,
--NR_RIGA_CANCELLAZIONE
CODICE_FONDO
)

SELECT 
P.ID_PROGETTO AS COD_LOCALE_PROGETTO,
NULL AS COD_PROC_AGG, 
'9999' AS CIG, --IN ASSENZA DI CIG ASSUME IL VALORE 9999
NULL AS MOTIVO_ASSENZA_CIG, --VERIFICARE TC22
NULL AS DESCR_PROCEDURA_AGG, --OBBLIGATORIO SE CIG = 9999
NULL AS TIPO_PROC_AGG, --VERIFICARE TC23
B.IMPORTO AS IMPORTO_PROCEDURA_AGG, --VERIFICARE TIPOLOGIA DI BANDO (AL MOMENTO NON ATTUATI) OBBLIGATORIO SE CIG = 9999
B.DATA_APERTURA AS DATA_PUBBLICAZIONE, --VERIFICARE TIPOLOGIA DI BANDO (AL MOMENTO NON ATTUATI) OBBLIGATORIO SE CIG = 9999
NULL AS IMPORTO_AGGIUDICATO, --VERIFICARE TIPOLOGIA DI BANDO (AL MOMENTO NON ATTUATI) OBBLIGATORIO SE CIG = 9999
NULL AS DATA_AGGIUDICAZIONE,  --VERIFICARE TIPOLOGIA DI BANDO (AL MOMENTO NON ATTUATI) OBBLIGATORIO SE CIG = 9999
NULL AS FLG_CANCELLAZIONE,
@IdInvio AS ID_INVIO,
ISNULL(@rNumber,0) + ROW_NUMBER() OVER(ORDER BY P.ID_PROGETTO ASC) AS NR_RIGA_INVIO,
'FESR20142020' AS CODICE_FONDO  
FROM vPROGETTO P
INNER JOIN vBANDO B ON
P.ID_BANDO = B.ID_BANDO
INNER JOIN PROGETTO_STORICO PS ON
P.ID_PROGETTO = PS.ID_PROGETTO
INNER JOIN zPROGRAMMAZIONE PRG ON
B.ID_PROGRAMMAZIONE = PRG.ID
INNER JOIN zPSR_ALBERO PA ON
PRG.COD_TIPO = PA.CODICE
INNER JOIN zPSR PSR ON
PA.COD_PSR = PSR.CODICE
INNER JOIN BANDO_RESPONSABILI BR ON
B.ID_BANDO = BR.ID_BANDO
WHERE 
P.COD_STATO IN ('F','V','S','O','T','X','C','Y','E','R') 
AND 
PSR.CODICE = 'POR20142020'
AND
P.COD_AGEA IS NOT NULL
--AND
--BR.ATTIVO = 1 AND BR.PROVINCIA IS NULL
--AND
--B.DATA_SCADENZA BETWEEN @DataDa AND @DataA

SELECT ISNULL(MAX(NR_RIGA_INVIO),0) FROM IGRUE_MONIT.dbo.IGRUE_PG00 WHERE ID_INVIO = @IdInvio

END
