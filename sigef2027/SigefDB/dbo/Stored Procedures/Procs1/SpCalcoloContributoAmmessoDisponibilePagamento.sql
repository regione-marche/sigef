-- =============================================

CREATE PROCEDURE [dbo].[SpCalcoloContributoAmmessoDisponibilePagamento]
(
	@ID_PROGETTO INT, --ID_PROGETTO CORRELATO
	@ID_DOMANDA_PAGAMENTO INT,
	@COD_TIPO_INVESTIMENTO INT,
	@ID_PAGAMENTO_RICHIESTO INT
)
AS
DECLARE @CONTRIBUTO_AMMESSO_DISPONIBILE DECIMAL(18,2)/*
DECLARE @ID_PROGETTO INT, @ID_DOMANDA_PAGAMENTO INT,@ID_PAGAMENTO_RICHIESTO INT, @COD_TIPO_INVESTIMENTO INT
SET @ID_PROGETTO =118
SET @ID_DOMANDA_PAGAMENTO =197
SET @COD_TIPO_INVESTIMENTO=1
SET @ID_PAGAMENTO_RICHIESTO =326*/

DECLARE @ID_PROG_INTEGRATO INT
SELECT @ID_PROG_INTEGRATO=ISNULL(ID_PROG_INTEGRATO,ID_PROGETTO) FROM PROGETTO WHERE ID_PROGETTO=@ID_PROGETTO

DECLARE @ID_VARIANTE INT,@DATA_MODIFICA_PAGAMENTO DATETIME,@TIPO_DOMANDA_PAGAMENTO CHAR(3)
SELECT @DATA_MODIFICA_PAGAMENTO=DATA_MODIFICA,@TIPO_DOMANDA_PAGAMENTO=COD_TIPO,@ID_VARIANTE=ID_VARIAZIONE_ACCERTATA 
FROM DOMANDA_DI_PAGAMENTO WHERE ID_DOMANDA_PAGAMENTO=@ID_DOMANDA_PAGAMENTO
IF @ID_VARIANTE IS NULL
	SELECT @ID_VARIANTE=MAX(ID_VARIANTE) FROM VARIANTI WHERE ID_PROGETTO=@ID_PROG_INTEGRATO AND APPROVATA=1 AND ANNULLATA=0 
	AND DATA_MODIFICA<@DATA_MODIFICA_PAGAMENTO

SET @CONTRIBUTO_AMMESSO_DISPONIBILE =dbo.calcoloContributoTotaleProgettoCorrelato(@ID_PROGETTO,1,@ID_VARIANTE)

--CONTROLLO L'EFFETTIVO AMMONTARE AMMESSO IN GRADUATORIA IN CASO DI FINANZIABILITA PARZIALE
DECLARE @CONTRIBUTO_AMMESSO_IN_GRADUATORIA DECIMAL(18,2)
SELECT @CONTRIBUTO_AMMESSO_IN_GRADUATORIA=CONTRIBUTO_DI_MISURA FROM GRADUATORIA_PROGETTI_FINANZIABILITA WHERE ID_PROGETTO=@ID_PROGETTO
IF(@CONTRIBUTO_AMMESSO_IN_GRADUATORIA IS NULL)
	SELECT @CONTRIBUTO_AMMESSO_IN_GRADUATORIA=CONTRIBUTO_TOTALE FROM GRADUATORIA_PROGETTI WHERE ID_PROGETTO=@ID_PROGETTO
IF(@CONTRIBUTO_AMMESSO_IN_GRADUATORIA IS NOT NULL AND @CONTRIBUTO_AMMESSO_IN_GRADUATORIA<@CONTRIBUTO_AMMESSO_DISPONIBILE) 
	SET @CONTRIBUTO_AMMESSO_DISPONIBILE=@CONTRIBUTO_AMMESSO_IN_GRADUATORIA

--SOTTRAGGO IL CONTRIBUTO AMMESSO DELLE DOMANDE PRECEDENTI.. 
DECLARE @CONTRIBUTO_AMMESSO DECIMAL(18,2),@CONTRIBUTO_AMMESSO_ALTRI_INVESTIMENTI DECIMAL(18,2)
SELECT @CONTRIBUTO_AMMESSO=SUM(IMPORTO_AMMISSIBILE) FROM DOMANDA_DI_PAGAMENTO_ESPORTAZIONE E 
INNER JOIN DOMANDA_DI_PAGAMENTO DP ON E.ID_DOMANDA_PAGAMENTO=DP.ID_DOMANDA_PAGAMENTO
WHERE DP.ID_DOMANDA_PAGAMENTO<@ID_DOMANDA_PAGAMENTO AND DP.APPROVATA=1 AND DP.ANNULLATA=0 AND E.ID_PROGETTO=@ID_PROGETTO
AND DP.COD_TIPO!='ANT'
--E L'AMMESSO DI QUELLA ATTUALE SUGLI ALTRI INVESTIMENTI
SELECT @CONTRIBUTO_AMMESSO_ALTRI_INVESTIMENTI=SUM(CONTRIBUTO_AMMESSO) FROM PAGAMENTI_RICHIESTI PR
INNER JOIN PIANO_INVESTIMENTI I ON PR.ID_INVESTIMENTO=I.ID_INVESTIMENTO
WHERE ID_DOMANDA_PAGAMENTO=@ID_DOMANDA_PAGAMENTO AND I.ID_PROGETTO=@ID_PROGETTO 
AND (@ID_PAGAMENTO_RICHIESTO IS NULL OR ID_PAGAMENTO_RICHIESTO!=@ID_PAGAMENTO_RICHIESTO)

SET @CONTRIBUTO_AMMESSO_DISPONIBILE=@CONTRIBUTO_AMMESSO_DISPONIBILE-ISNULL(@CONTRIBUTO_AMMESSO,0)
-ISNULL(@CONTRIBUTO_AMMESSO_ALTRI_INVESTIMENTI,0)
IF(@CONTRIBUTO_AMMESSO_DISPONIBILE<0) SET @CONTRIBUTO_AMMESSO_DISPONIBILE=0
SELECT @CONTRIBUTO_AMMESSO_DISPONIBILE AS CONTRIBUTO_AMMESSO_DISPONIBILE
