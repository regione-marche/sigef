CREATE  PROCEDURE [dbo].[calcoloStep226_2]
@IdProgetto int
AS
BEGIN
 
--- 226  Superamento tetto massimo di contributo ammesso da bando per la Comunità Montana
-- BANDO SECONDA SCADENZA =141
-- BANDO terza SCADENZA = 269
 /*declare @IdProgetto int =9644*/
 
DECLARE @RESULT int,@CONTRIBUTO_RICHIESTO_PROGETTO DECIMAL (10,2),@CONTRIBUTO_RICHIESTO_PASSATO DECIMAL (10,2),
		@PLV_ATTIVITA_CONNESSA DECIMAL (10,2), @PLV_ATTIVITA_CONNESSA_PASSATO DECIMAL (10,2),
		@QUOTA_CONTRIBUTO_TOTALE DECIMAL(10,2),	@ID_IMPRESA INT , @ID_BANDO int, @CUAA VARCHAR(16)

SET @RESULT = 0  -- Impongo lo Step NON verificato
--------------------------------------------------------------------------------------------------------------
SELECT @ID_IMPRESA =P.ID_IMPRESA  , @ID_BANDO = ID_BANDO, @CUAA=IMP.CUAA FROM PROGETTO P INNER JOIN IMPRESA IMP ON IMP.ID_IMPRESA =P.ID_IMPRESA  WHERE ID_PROGETTO = @IdProgetto  

SELECT  @CONTRIBUTO_RICHIESTO_PROGETTO =SUM(PIANO_INVESTIMENTI.CONTRIBUTO_RICHIESTO) 
FROM PIANO_INVESTIMENTI
	INNER JOIN PROGETTO ON PIANO_INVESTIMENTI.ID_PROGETTO = PROGETTO.ID_PROGETTO
WHERE (PIANO_INVESTIMENTI.ID_PROGETTO = @IdProgetto) AND 
		((PIANO_INVESTIMENTI.ID_INVESTIMENTO_ORIGINALE IS NULL AND PROGETTO.FLAG_DEFINITIVO =0 ) 
		OR (PIANO_INVESTIMENTI.ID_INVESTIMENTO_ORIGINALE IS NOT NULL AND PROGETTO.FLAG_DEFINITIVO =1 AND ID_VARIANTE IS NULL)) 

--ID_BANDO in (141, 269)
-- BANDO terza SCADENZA = 269

SELECT @CONTRIBUTO_RICHIESTO_PASSATO =SUM(CONTRIBUTO_RICHIESTO) 
FROM PIANO_INVESTIMENTI 
WHERE ID_INVESTIMENTO_ORIGINALE IS NOT NULL AND ID_VARIANTE IS NULL 
	  AND ID_PROGETTO IN ( SELECT ID_PROGETTO FROM VPROGETTO 
							WHERE COD_STATO <> 'R' AND ID_IMPRESA  = @ID_IMPRESA  AND FLAG_DEFINITIVO =1 AND  ID_PROGETTO <> @IdProgetto  AND ID_BANDO =@ID_BANDO)      
 

SET @PLV_ATTIVITA_CONNESSA = ( SELECT SUM(ISNULL(PLV,0)) FROM PLV_IMPRESA 
							   WHERE ID_PROGETTO = @IdProgetto  AND PREVISIONALE =1  AND ID_ATTIVITA_CONNESSA IS NOT NULL )
SET @PLV_ATTIVITA_CONNESSA_PASSATO = (SELECT SUM(ISNULL(PLV,0)) FROM PLV_IMPRESA 
							          WHERE ID_PROGETTO IN (SELECT ID_PROGETTO FROM VPROGETTO 
															 WHERE COD_STATO <> 'R' AND ID_IMPRESA  = @ID_IMPRESA  AND FLAG_DEFINITIVO =1 AND  ID_PROGETTO <> @IdProgetto AND ID_BANDO =@ID_BANDO )
									   AND PREVISIONALE =1  AND ID_ATTIVITA_CONNESSA IS NOT NULL)
			
SET @QUOTA_CONTRIBUTO_TOTALE = (ISNULL(@CONTRIBUTO_RICHIESTO_PROGETTO,0) + ISNULL(@CONTRIBUTO_RICHIESTO_PASSATO,0) - ISNULL(@PLV_ATTIVITA_CONNESSA,0 ) - ISNULL(@PLV_ATTIVITA_CONNESSA_PASSATO,0))
/* commentato SELECT @CONTRIBUTO_RICHIESTO_PROGETTO as richiesto, @CONTRIBUTO_RICHIESTO_PASSATO as pass, @PLV_ATTIVITA_CONNESSA as PLV, @QUOTA_CONTRIBUTO_TOTALE */

/*
CUAA 82005390412 
CODICE FISCALE 01182940419
COMUNITA' MONTANA DEL MONTEFELTRO  AMBITO  1    €187500
*/
IF  (@CUAA = '82005390412' OR @CUAA='01182940419' )BEGIN
	IF((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <=241555.97) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <=225080.00)) SET @RESULT = 1
	ELSE IF  @QUOTA_CONTRIBUTO_TOTALE  <= 187500 SET @RESULT = 1
END
/*
CUAA 82004630412 
CODICE FISCALE 00904150414 
COMUNITA' MONTANA ALTO E MEDIO METAURO  AMBITO  2a    €396000*/
ELSE IF (@CUAA = '82004630412' OR @CUAA='00904150414' ) BEGIN
		IF ((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 511573.21) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 476680.00))SET @RESULT = 1
		ELSE IF @QUOTA_CONTRIBUTO_TOTALE   <= 396000 SET @RESULT = 1
END
/*
CUAA 82005770415 
CODICE FISCALE 82005770415 
COMUNITA' MONTANA DEL CATRIA E DEL NERONE  AMBITO  2b    €484800*/
ELSE IF (@CUAA = '82005770415' )BEGIN
		IF ((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 625783.21) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 583100.00 ))SET @RESULT = 1
		ELSE IF @QUOTA_CONTRIBUTO_TOTALE   <= 484800 SET @RESULT = 1
END
 
/*         SOPPRESSA CON LEGGE REGIONALE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!    
CUAA 81002770410 
CODICE FISCALE 01112030414 
COMUNITA' MONTANA DEL METAURO ZONA E  AMBITO  zona E    €170400*/
ELSE IF (@CUAA = '81002770410' OR @CUAA='01112030414' )BEGIN
		IF (@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 0 )  SET @RESULT = 1
		ELSE IF  @QUOTA_CONTRIBUTO_TOTALE   <= 170400 SET @RESULT = 1
		END
/*
CUAA 81002870426 
CODICE FISCALE 00872030424 
COMUNITA' MONTANA DELL'ESINO - FRASASSI  AMBITO  3    €339600*/
ELSE IF  (@CUAA = '81002870426' OR @CUAA='00872030424' ) BEGIN
		IF ((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 437500.92) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 407660.00 )) SET @RESULT = 1
		ELSE IF  @QUOTA_CONTRIBUTO_TOTALE   <= 339600 SET @RESULT = 1
END 
/* 
CUAA 83006070433 
CODICE FISCALE 83006070433 
COMUNITA' MONTANA ALTE VALLI DEL POTENZA E DELL'ESINO  AMBITO  4    €450300*/
ELSE IF (@CUAA = '83006070433'   ) BEGIN
		 IF ((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 583456.18) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 543660.00 )) SET @RESULT = 1
		 ELSE IF @QUOTA_CONTRIBUTO_TOTALE   <= 450300 SET @RESULT = 1
	 END
/*
CUAA 81001760438
CODICE FISCALE 81001760438 
COMUNITA' MONTANA DI CAMERINO  AMBITO  5    €284400*/
ELSE IF (@CUAA = '81001760438'   )BEGIN
		 IF ((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 364888.17) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 340000.00 )) SET @RESULT = 1
		 ELSE IF @QUOTA_CONTRIBUTO_TOTALE   <= 284400 SET @RESULT = 1
	 END
 
/*
CUAA 83012360430 
CODICE FISCALE 01059640431 
COMUNITA' MONTANA DEI MONTI AZZURRI  AMBITO  6    €145500*/
ELSE IF  (@CUAA = '83012360430' OR @CUAA='01059640431' )BEGIN
		 IF ((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 187187.63) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 174420.00 )) SET @RESULT = 1
		 ELSE IF @QUOTA_CONTRIBUTO_TOTALE   <= 145500 SET @RESULT = 1
	 END
/*
CUAA 80003250448
 CODICE FISCALE 80003250448 
COMUNITA' MONTANA DEI SIBILLINI  AMBITO  7    €247500*/
ELSE IF (@CUAA = '80003250448'  ) BEGIN
		 IF ((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 319642.04) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 297840.00 )) SET @RESULT = 1
		 ELSE IF @QUOTA_CONTRIBUTO_TOTALE   <= 247500 SET @RESULT = 1
	 END
/* 
ambito 8	10.34%	€                   377294.37
CUAA  CODICE FISCALE  92008750447 
COMUNITA' MONTANA DEL TRONTO***  AMBITO  8    €294000
*/
ELSE IF (@CUAA = '92008750447 '  ) BEGIN
		 IF ((@ID_BANDO = 269 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 377294.37) or (@ID_BANDO = 375 AND  @QUOTA_CONTRIBUTO_TOTALE  <= 351560.00 ))  SET @RESULT = 1
		 ELSE IF @QUOTA_CONTRIBUTO_TOTALE   <= 294000 SET @RESULT = 1
	 END
SELECT @RESULT
 END
